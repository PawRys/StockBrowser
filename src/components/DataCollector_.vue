<script setup>
import { ref } from 'vue'
import { db as idb } from '../assets/dexiedb.js'
import {
	textareaValue_ref,
	message_ref,
	dataType_ref,
} from './DataCollector_Scripts.js'
import {
	validate,
	prepareData,
	updateProductsTable,
	calcQuant,
	calcPrice,
} from './DataCollector_Scripts.js'
import IconBroom from './icons/IconBroom.vue'
import IconCheck from './icons/IconCheck.vue'
import IconDisk from './icons/IconDisk.vue'
import ExampleData from './DataCollector_ExampleData.vue'

async function textareaPaste(e) {
	const permission = await navigator.permissions.query({
		name: 'clipboard-read',
	})
	if (permission.state == 'denied') {
		alert(
			`Uprawnienia do schowka dla tej witryny zostały wyłączone. Ask Google for help.`
		)
		return
	}
	const clipboardData = await navigator.clipboard
		.readText()
		.catch(reason => console.error(reason))
	textareaValue_ref.value = clipboardData
	validate(textareaValue_ref.value)
}

function checkValidation() {
	validate(textareaValue_ref.value)
}

function textareaClear() {
	textareaValue_ref.value = ''
	validate(textareaValue_ref.value)
}

async function bulkAddIDB() {
	console.time('bulkAddIDB')
	message_ref.value = 'Loading... ⏳'
	let updatedProducts = null

	if (dataType_ref.value !== 'code') {
		updatedProducts = await updateProductsTable()
	} else {
		// const fetchURL = 'https://bossman.hekko24.pl/apps/assets/website/app_stocks/stocks.3.php'
		const fetchURL = 'http://localhost:3000/api/index.php'
		const URLparams = {
			action: 'request',
			pin: textareaValue_ref.value,
		}
		const fetchSettings = {
			method: 'POST',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
			},
			body: new URLSearchParams(URLparams).toString(),
		}
		const fetchResult = await fetch(fetchURL, fetchSettings).catch(reason =>
			console.error(reason)
		)
		const { message, data } = await fetchResult.json()

		if (data) updatedProducts = data
		message_ref.value = message
	}

	if (updatedProducts) {
		await idb.products.clear()
		await idb.products.bulkAdd(updatedProducts).catch(err => {
			message_ref.value = 'Coś poszło nie tak ❗'
			console.log(err)
			return
		})
	}
	if (dataType_ref.value === 'code') {
		// message_ref.value = '📜 Pobrano dane z chmury ✔'
	}
	if (dataType_ref.value === 'products') {
		message_ref.value = '📜 Zaktualizowano produkty ✔'
	}
	if (dataType_ref.value === 'prices') {
		message_ref.value = '💵 Zaktualizowano ceny ✔'
	}
	if (dataType_ref.value === 'stocks') {
		message_ref.value = '📦 Zaktualizowano ilości ✔'
	}
	console.log(updatedProducts)
	console.timeEnd('bulkAddIDB')
}
</script>

<template>
	<h2>Załaduj dane</h2>
	<p>[Tu instrukcja]</p>
	<div class="grid">
		<textarea
			id="datainsert"
			name="datainsert"
			rows="10"
			v-model="textareaValue_ref"
			@input="checkValidation"></textarea>
		<p
			class="message"
			:class="{ visible: message_ref, hidden: !message_ref }">
			{{ message_ref }}
		</p>
		<button class="button" @click="textareaClear">
			Wyczyść
			<IconBroom />
		</button>
		<button class="button" @click="textareaPaste">
			Schowek
			<IconDisk />
		</button>
		<button class="button accent" @click="bulkAddIDB" v-if="dataType_ref">
			Zatwierdź
			<IconCheck />
		</button>
	</div>

	<hr />
	<ExampleData />
</template>

<style scoped>
.grid {
	display: grid;
	gap: 0.5ex;
	grid-template-columns: repeat(3, max-content) 1fr;
}

#datainsert,
.message {
	grid-column: 1 / span 4;
	width: 100%;
}

.message {
	margin: 0;
	transition-property: height, scale;
	transition-duration: var(--transition-duration);
}

.message.hidden {
	height: 0ch;
	scale: 1 0;
}

.message.visible {
	height: 3ch;
	scale: 1 1;
}

p {
	overflow: hidden;
	max-height: 8ch;
}
</style>
